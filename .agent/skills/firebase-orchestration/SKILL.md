---
name: firebase-orchestration
description: Firestore を使用したリアルタイム通信（BBS、カウンター）の実装と、データの整合性を維持するためのスキル
---

# Firebase Orchestration Skill

このスキルは、サーバーレスなリアルタイム機能を、レトロな UI 体験と融合させながら安全に実装するためのガイドラインです。

## 🔥 実装コア

### 1. リアルタイム・サブスクリプション
- `onSnapshot` を使用し、BBS などの投稿をリロードなしで反映させる。
- コンポーネントのアンマウント時に必ずリスナーを解除 (`unsubscribe`) する。

### 2. データ構造の設計
- **BBS**: `createdAt` によるソートを基本とし、ID によるユニーク性を確保。
- **Counter**: セッションベースの増分制御による、過剰なカウントアップの防止。
- **Gallery**: Firestore でメタデータ（タイトル、説明、URL）を管理し、画像の実体は Storage またはローカルアセットに置く。

### 3. ストレージ・オーケストレーション（無料枠の回避策）
- **標準構成**: `ref(storage, path)` と `getDownloadURL(ref)` を使用。
- **ハイブリッド構成 (Sparkプラン推奨)**: Firebase Storage の料金制限を避けるため、画像実体は `public/assets/` で Git 管理し、Firestore にはその「ローカルパス」のみを記録する。
- **フォールバック**: 画像のロード失敗時には、レトロな「NO IMAGE」GIF などを表示する。

### 4. セキュリティ
- セキュリティルールにおいて、許可されたパス (`/messages`, `/counter`, `/gallery`) 以外へのアクセスを制限。
- クライアント側での簡易バリデーションと、Firebase 側でのスキーマチェックの併用。

### 5. デプロイ設定と接続制限
- **REMOTE_TARGET**: サーバー上の正確な公開ディレクトリを指定。
- **海外IP制限の回避**: GitHub Actions の IP がサーバー側で制限されている場合、セキュリティ設定の緩和や特定 IP のホワイトリスト化を検討する。
- **PORT/SSH**: デフォルト以外の場合は明示的に設定。`StrictHostKeyChecking` は必要に応じて `no` に設定し、対話的プロンプトを回避する。

## 🛠 ベストプラクティス
- **ローカルステートとの同期**: サーバーからのデータ取得と、React の `useState` への反映をスムーズに行う。
- **エッジケース対応**: 画像のロード失敗時には、レトロな「NO IMAGE」GIF などを表示するフォールバックを実装。
- **エラーハンドリング**: 接続切れやパーミッションエラー時のユーザーへの適切な通知。

## 🚫 禁止事項
- **APIキーのハードコード**: 必ず環境変数から読み込むこと。
- **無限ループ**: `useEffect` 内での過剰な書き込みによる、読み書き回数の増大（クォータの浪費）に注意する。
